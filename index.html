<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solfeo Avanzado para Coro - M√≥dulo 1: Ritmo y Melod√≠a</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in-section { opacity: 0; animation: fadeIn 0.8s ease-out forwards; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; font-size: 0.875rem; }
        input[type="range"] { width: 100%; cursor: pointer; accent-color: #84cc16; }
        input[type="number"], select { padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 0.375rem; width: 100%; }
        button, .styled-button-link { background-color: #a3e635; color: #3f6212; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.2s; display: inline-block; text-align: center; border: none; cursor: pointer;}
        button:hover, .styled-button-link:hover { background-color: #84cc16; }
        button:disabled { background-color: #d9f99d; cursor: not-allowed; }
        h1 { color: #111827; font-size: 1.875rem; line-height: 2.25rem; font-weight: 700;}
        h2 { color: #111827; font-size: 1.5rem; line-height: 2rem; font-weight: 700;}
        h3 { color: #365314; font-size: 1.25rem; line-height: 1.75rem; font-weight: 600; border-bottom: 2px solid #a3e635; padding-bottom: 0.35rem; margin-top: 2rem; margin-bottom: 1rem; }
        p, li { color: #374151; line-height: 1.75; margin-bottom: 1rem; }
        strong { color: #1F2937; font-weight: 600; }
        blockquote { border-left: 6px solid #a3e635; padding: 1rem 1.5rem; margin: 2rem 0; font-style: italic; color: #374151; background-color: #ffffff; border-radius: 0 0.5rem 0.5rem 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); }
        .section-bg-light { background-color: #f7fee7; }
        .section-bg-white { background-color: #FFFFFF; }
        .instructional-text { font-size: 0.875rem; color: #4B5563; margin-top: 0.5rem; }
        .output-box { margin-top: 1rem; padding: 0.75rem; background-color: #ecfdf5; border: 1px solid #d1fae5; border-radius: 0.375rem; font-size: 0.875rem; color: #065f46; text-align: center; font-weight: 500; min-height: 40px; }
        .slider-label-container { display: flex; justify-content: space-between; font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem; }
        footer ul { list-style: none; padding-left: 0; }
        footer li { margin-bottom: 0.75rem; }
        footer a { color: #4d7c0f; text-decoration: none; }
        footer a:hover { text-decoration: underline; }
        .header-subtitle { font-size: 1.25rem; line-height: 1.75rem; font-weight: 600; margin-top: 0.25rem; }
        .header-attribution { font-size: 0.875rem; line-height: 1.25rem; margin-top: 0.5rem; opacity: 0.9; }
        nav.page-nav a { margin: 0 0.75rem; color: #f0fdf4; font-weight: 500; text-decoration: none; border-bottom: 2px solid transparent; transition: border-color 0.2s; padding-bottom: 2px; }
        nav.page-nav a:hover, nav.page-nav a.active { border-color: #a3e635; color: #ffffff;}
        .interactive-block { margin-top: 1.5rem; margin-bottom: 1.5rem; padding: 1.5rem; border: 1px solid #d9f99d; border-radius: 0.5rem; background-color: #ffffff; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); }
        .notation-container { background-color: #f0fdf4; border: 1px solid #d9f99d; padding: 10px; border-radius: 0.25rem; min-height: 120px; overflow-x: auto; display: flex; align-items: center; }
        .notation-svg { display: block; min-width: 400px; height: 100px; }
        .staff-line { stroke: #a3a3a3; stroke-width: 1; }
        .note-head { fill: #1f2937; }
        .note-stem { stroke: #1f2937; stroke-width: 1.5; }
        .measure-line { stroke: #525252; stroke-width: 1; }
        .clef { font-size: 42px; font-family: serif; fill: #1f2937; dominant-baseline: middle;}
        .time-sig-num { font-size: 18px; font-weight: bold; fill: #1f2937; text-anchor: middle; dominant-baseline: middle;}
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">

    <header class="bg-gradient-to-r from-lime-600 to-green-600 text-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <h1 class="text-2xl md:text-3xl font-bold">Solfeo Avanzado para Cantantes de Coro</h1>
            <p class="header-subtitle">M√≥dulo 1: Ritmo y Melod√≠a Complejos</p>
            <nav class="page-nav mt-2 text-sm md:text-base">
                <a href="#solfeo_mod1" class="active">M√≥dulo 1</a> |
                <a href="#">M√≥dulo 2</a> |
                <a href="#">M√≥dulo 3</a> |
                <a href="#">M√≥dulo 4</a>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">

        <section id="intro" class="mb-12 p-6 rounded-lg shadow-lg section-bg-white dynamic-content">
            <h2 class="text-lime-700 border-b-2 border-lime-200 pb-2 mb-6">1.1 Introducci√≥n: La Precisi√≥n del Solfeo en el Coro</h2>
            <p>Bienvenido/a al curso de Solfeo Avanzado para Cantantes de Coro. Mientras que las habilidades b√°sicas de solfeo son fundamentales para cualquier m√∫sico, el cantante de coro se enfrenta a desaf√≠os √∫nicos que demandan un nivel superior de lectura y comprensi√≥n musical. Este curso est√° dise√±ado para cantantes de nivel maestr√≠a y doctorado que buscan perfeccionar sus habilidades para abordar repertorio coral complejo con confianza y musicalidad.</p>
            <p>La precisi√≥n en el solfeo dentro de un ensamble coral no es solo una cuesti√≥n de cantar las notas y ritmos correctos; es la base para lograr una afinaci√≥n impecable, un empaste vocal homog√©neo, una articulaci√≥n conjunta precisa y una interpretaci√≥n estil√≠stica coherente. A diferencia del solista, el corista debe:</p>
            <ul class="list-disc list-inside pl-4 mb-4">
                <li>Seguir las indicaciones gestuales del director mientras lee la partitura.</li>
                <li>Escuchar activamente las otras voces para ajustar la afinaci√≥n arm√≥nica (considerando temperamentos justos vs. temperados).</li>
                <li>Navegar texturas polif√≥nicas complejas, manteniendo la independencia de su l√≠nea mel√≥dica.</li>
                <li>Adaptarse r√°pidamente a cambios de m√©trica, tonalidad y estilo.</li>
                <li>Potencialmente leer en claves menos comunes (Do en 3¬™, Do en 4¬™) en repertorio antiguo o contempor√°neo.</li>
            </ul>
            <p>Este m√≥dulo se centrar√° en los dos pilares fundamentales: el ritmo y la melod√≠a, abordando las complejidades que van m√°s all√° del solfeo b√°sico y que son cruciales para el √©xito en un coro de alto nivel.</p>
        </section>

        <section id="ritmo" class="mb-12 p-6 rounded-lg shadow-lg section-bg-light dynamic-content">
            <h2 class="text-lime-700 border-b-2 border-lime-200 pb-2 mb-6">1.2 Lectura R√≠tmica Avanzada</h2>
            <p>La precisi√≥n r√≠tmica es la columna vertebral de la m√∫sica coral. M√°s all√° de las figuras b√°sicas, el repertorio avanzado exige el dominio de estructuras m√©tricas y r√≠tmicas complejas.</p>

            <h3>Compases Complejos y de Amalgama</h3>
            <p>Los compases como 5/4, 7/8, 5/8, 11/8, etc., requieren una subdivisi√≥n interna consistente. Los compases de amalgama combinan grupos simples (ej. 5/8 como 2+3 o 3+2; 7/8 como 2+2+3, 3+2+2 o 2+3+2). La clave es identificar y sentir el patr√≥n de acentuaci√≥n impl√≠cito.</p>

            <h3>Polirritmia y Hemiola</h3>
            <p>La polirritmia implica la superposici√≥n de dos o m√°s divisiones r√≠tmicas diferentes simult√°neamente (ej. 3 contra 2). La hemiola es un tipo espec√≠fico donde se siente un cambio temporal de m√©trica, com√∫nmente 3 tiempos de binaria sinti√©ndose como 2 tiempos de ternaria (ej. en 6/8 sentir dos grupos de 3 corcheas vs. tres grupos de 2 corcheas). En coro, es vital mantener la propia l√≠nea r√≠tmica contra las otras voces.</p>

            <h3>Grupos Irregulares y Subdivisiones Complejas</h3>
            <p>M√°s all√° de los tresillos, encontramos quintillos, septillos, etc., y subdivisiones complejas de la unidad de tiempo. La subdivisi√≥n precisa y constante del pulso base es esencial.</p>

            <h3>S√≠ncopa y Cambios de M√©trica</h3>
            <p>La s√≠ncopa avanzada y los cambios de m√©trica frecuentes o irregulares desaf√≠an la estabilidad del pulso interno. Anticipar visualmente estos cambios y mantener una referencia interna del pulso son habilidades clave.</p>

            <div class="interactive-block">
                <h4 class="text-lg font-semibold mb-3 text-center text-lime-700">Generador Visual de Ritmos</h4>
                <p class="instructional-text text-center mb-4">Ajusta los par√°metros para generar y visualizar ritmos complejos.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="rhythm-tempo-slider">Tempo Conceptual (BPM): <span id="rhythm-tempo-value">90</span></label>
                        <input type="range" id="rhythm-tempo-slider" min="40" max="160" value="90" step="5">
                    </div>
                    <div>
                        <label for="rhythm-meter-select">Comp√°s:</label>
                        <select id="rhythm-meter-select">
                            <option value="4/4" selected>4/4</option>
                            <option value="3/4">3/4</option>
                            <option value="6/8">6/8</option>
                            <option value="5/4">5/4</option>
                            <option value="7/8">7/8</option>
                        </select>
                    </div>
                    <div>
                        <label for="rhythm-complexity-slider">Complejidad:</label>
                        <input type="range" id="rhythm-complexity-slider" min="1" max="5" value="2" step="1">
                        <div class="slider-label-container"><span>Baja</span><span id="rhythm-complexity-value">2</span><span>Alta</span></div>
                    </div>
                </div>
                <div class="notation-container mb-4">
                    <svg id="rhythm-notation-svg" class="notation-svg" viewBox="0 0 600 100" preserveAspectRatio="xMinYMid meet"></svg>
                </div>
                <div class="text-center">
                    <button id="generate-rhythm-btn">Generar Nuevo Ritmo</button>
                </div>
            </div>
        </section>

        <section id="melodia" class="mb-12 p-6 rounded-lg shadow-lg section-bg-white dynamic-content">
            <h2 class="text-lime-700 border-b-2 border-lime-200 pb-2 mb-6">1.3 Lectura Mel√≥dica Avanzada</h2>
            <p>La lectura mel√≥dica precisa en coro va m√°s all√° de reconocer intervalos diat√≥nicos simples. Requiere agilidad mental y auditiva para navegar armon√≠as y l√≠neas complejas.</p>

            <h3>Intervalos Complejos</h3>
            <p>El dominio incluye intervalos aumentados (ej. 4¬™ Aug), disminuidos (ej. 5¬™ Dim - tritono), y compuestos (mayores que la octava, ej. 10¬™m). El reconocimiento auditivo y la entonaci√≥n precisa dentro del contexto arm√≥nico son cruciales.</p>

            <h3>Cromatismo y Modulaci√≥n</h3>
            <p>Las l√≠neas mel√≥dicas con alto grado de cromatismo o que modulan r√°pidamente a tonalidades lejanas exigen una s√≥lida comprensi√≥n de las relaciones tonales y una lectura interv√°lica √°gil.</p>

            <h3>Lectura en Claves Menos Comunes</h3>
            <p>El repertorio coral, especialmente m√∫sica antigua o ciertas obras contempor√°neas, puede requerir leer en Clave de Do en 3¬™ (Contralto) o Do en 4¬™ (Tenor). La familiaridad con estas claves expande el repertorio accesible.</p>

            <h3>Modalidad y Atonalidad</h3>
            <p>La lectura modal requiere reconocer y entonar los patrones interv√°licos caracter√≠sticos de modos como el D√≥rico, Frigio, Lidio, Mixolidio. La m√∫sica atonal o con tonalidad extendida a menudo se basa m√°s en la lectura precisa de intervalos espec√≠ficos que en la relaci√≥n con un centro tonal claro.</p>

            <div class="interactive-block">
                 <h4 class="text-lg font-semibold mb-3 text-center text-lime-700">Entrenador Visual de Intervalos</h4>
                 <p class="instructional-text text-center mb-4">Genera intervalos complejos para practicar su reconocimiento visual.</p>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                     <div>
                         <label for="interval-type-select">Tipo de Intervalo:</label>
                         <select id="interval-type-select">
                             <option value="m2">2¬™ menor</option>
                             <option value="M2">2¬™ Mayor</option>
                             <option value="m3">3¬™ menor</option>
                             <option value="M3">3¬™ Mayor</option>
                             <option value="P4">4¬™ Justa</option>
                             <option value="A4">4¬™ Aumentada (Tritono)</option>
                             <option value="d5">5¬™ Disminuida (Tritono)</option>
                             <option value="P5">5¬™ Justa</option>
                             <option value="m6">6¬™ menor</option>
                             <option value="M6">6¬™ Mayor</option>
                             <option value="m7">7¬™ menor</option>
                             <option value="M7">7¬™ Mayor</option>
                             <option value="P8">8¬™ Justa</option>
                             <option value="m9">9¬™ menor</option>
                             <option value="M9">9¬™ Mayor</option>
                             <option value="m10">10¬™ menor</option>
                             <option value="M10">10¬™ Mayor</option>
                         </select>
                     </div>
                     <div>
                        <label for="interval-complexity-slider">Complejidad Contextual (Conceptual):</label>
                        <input type="range" id="interval-complexity-slider" min="0" max="100" value="0" step="10">
                        <div class="slider-label-container"><span>Simple</span><span id="interval-complexity-value">0</span><span>Complejo</span></div>
                     </div>
                 </div>
                 <div class="notation-container mb-4">
                     <svg id="interval-notation-svg" class="notation-svg" viewBox="0 0 200 100" preserveAspectRatio="xMinYMid meet"></svg>
                 </div>
                 <div class="text-center">
                     <button id="generate-interval-btn" class="mr-2">Generar Intervalo</button>
                     <button id="show-interval-btn">Mostrar Nombre</button>
                 </div>
                 <div id="interval-answer-output" class="output-box mt-4 invisible">Respuesta aparecer√° aqu√≠.</div>
            </div>

            <div class="interactive-block">
                 <h4 class="text-lg font-semibold mb-3 text-center text-lime-700">Generador Visual de Melod√≠as</h4>
                 <p class="instructional-text text-center mb-4">Genera melod√≠as cortas para practicar lectura a primera vista con dificultad ajustable.</p>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                     <div>
                         <label for="melody-difficulty-slider">Dificultad Mel√≥dica:</label>
                         <input type="range" id="melody-difficulty-slider" min="1" max="5" value="2" step="1">
                         <div class="slider-label-container"><span>Baja</span><span id="melody-difficulty-value">2</span><span>Alta</span></div>
                     </div>
                     <div>
                         <label for="melody-length-slider">Longitud (compases):</label>
                         <input type="range" id="melody-length-slider" min="2" max="8" value="4" step="1">
                         <div class="slider-label-container"><span>2</span><span id="melody-length-value">4</span><span>8</span></div>
                     </div>
                     <div>
                         <label for="melody-mode-select">Tonalidad/Modo:</label>
                         <select id="melody-mode-select">
                             <option value="major" selected>Mayor</option>
                             <option value="minor">Menor (Natural)</option>
                             <option value="dorian">D√≥rico</option>
                             <option value="mixolydian">Mixolidio</option>
                             <option value="chromatic">Crom√°tico/Atonal</option>
                         </select>
                     </div>
                 </div>
                 <div class="notation-container mb-4">
                     <svg id="melody-notation-svg" class="notation-svg" viewBox="0 0 600 100" preserveAspectRatio="xMinYMid meet"></svg>
                 </div>
                 <div class="text-center">
                     <button id="generate-melody-btn">Generar Melod√≠a</button>
                 </div>
            </div>
        </section>

         <section id="aplicacion" class="mb-12 p-6 rounded-lg shadow-lg section-bg-light dynamic-content">
            <h2 class="text-lime-700 border-b-2 border-lime-200 pb-2 mb-6">1.4 Integraci√≥n y Aplicaci√≥n Coral</h2>
            <p>La verdadera prueba del solfeo avanzado ocurre en el contexto de la interpretaci√≥n coral. Los elementos r√≠tmicos y mel√≥dicos complejos rara vez aparecen aislados. Una obra de Stravinsky puede combinar cambios m√©tricos constantes con l√≠neas mel√≥dicas angulares y crom√°ticas. Una fuga de Bach exige independencia r√≠tmica y mel√≥dica absoluta en una textura polif√≥nica densa. Un motete renacentista puede requerir leer en claves de Do y navegar por armon√≠as modales con afinaci√≥n justa.</p>
            <p>El objetivo final de este entrenamiento es desarrollar la capacidad de:</p>
            <ul class="list-disc list-inside pl-4 mb-4">
                <li>Decodificar r√°pidamente la notaci√≥n compleja.</li>
                <li>Internalizar el ritmo y la melod√≠a antes de emitir sonido.</li>
                <li>Escuchar el contexto arm√≥nico y ajustar la afinaci√≥n instant√°neamente.</li>
                <li>Mantener la propia parte con precisi√≥n r√≠tmica y mel√≥dica dentro de la textura coral.</li>
                <li>Liberar recursos cognitivos de la lectura para enfocarse en la musicalidad, la expresi√≥n y la comunicaci√≥n con el director y el ensamble.</li>
            </ul>
            <p>Los m√≥dulos siguientes explorar√°n la lectura arm√≥nica, la afinaci√≥n y la aplicaci√≥n pr√°ctica a extractos de repertorio coral.</p>
        </section>

        <section class="mt-12 text-center">
             <a href="solfeo_mod2.html" class="styled-button-link">
                 Continuar al M√≥dulo 2 ‚Üí
             </a>
         </section>

    </main>

     <footer class="mt-16 pt-8 border-t border-gray-300 text-sm text-gray-600">
         <p class="footer-attribution">Curso de Solfeo Avanzado para Cantantes de Coro - M√≥dulo 1</p>
         <p class="footer-attribution">Desarrollado para Nivel Posgrado</p>
     </footer>

    <script>
        const sections_solfeo_mod1 = document.querySelectorAll('.fade-in-section');
        const observerOptions_solfeo_mod1 = { root: null, rootMargin: '0px', threshold: 0.1 };
        const observerCallback_solfeo_mod1 = (entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('fade-in-section');
                    observer.unobserve(entry.target);
                }
            });
        };
        const observer_solfeo_mod1 = new IntersectionObserver(observerCallback_solfeo_mod1, observerOptions_solfeo_mod1);
        sections_solfeo_mod1.forEach(section => { observer_solfeo_mod1.observe(section); });

        function setupSVG(svgId, height = 100, width = 600) {
            const svg = d3.select(`#${svgId}`);
            if (svg.empty()) { console.error(`SVG element #${svgId} not found.`); return null; }
            svg.selectAll("*").remove();
            svg.attr("height", height)
               .attr("width", '100%')
               .attr("viewBox", `0 0 ${width} ${height}`);
            const g = svg.append("g");
            return { svg: g, width, height };
        }

        function drawStaff(svg, width, height, lines = 5) {
            const staffTop = height / 2 - (lines - 1) * 5;
            const lineSpacing = 10;
            const staffHeight = (lines - 1) * lineSpacing;
            for (let i = 0; i < lines; i++) {
                svg.append("line")
                   .attr("x1", 10)
                   .attr("y1", staffTop + i * lineSpacing)
                   .attr("x2", width - 10)
                   .attr("y2", staffTop + i * lineSpacing)
                   .attr("class", "staff-line");
            }
            return { staffTop, lineSpacing, staffHeight };
        }

        function drawClef(svg, staffTop, lineSpacing, type = 'G') {
             const xPos = 20;
             if (type === 'G') {
                 svg.append("text")
                    .attr("x", xPos)
                    .attr("y", staffTop + lineSpacing * 3)
                    .attr("class", "clef")
                    .text("ùÑû");
             } else if (type === 'F') {
                 svg.append("text")
                     .attr("x", xPos)
                     .attr("y", staffTop + lineSpacing)
                     .attr("class", "clef")
                     .text("ùÑ¢");
             }
             return xPos + 25;
        }

        function drawTimeSignature(svg, xPos, staffTop, lineSpacing, topNum, bottomNum) {
             svg.append("text")
                .attr("x", xPos)
                .attr("y", staffTop + lineSpacing * 1)
                .attr("class", "time-sig-num")
                .text(topNum);
             svg.append("text")
                .attr("x", xPos)
                .attr("y", staffTop + lineSpacing * 3)
                .attr("class", "time-sig-num")
                .text(bottomNum);
             return xPos + 25;
        }

        function drawNote(svg, x, y, durationType = 'q') {
            const noteHeadRadius = 5;
            const isFilled = ['q', 'e', 's'].includes(durationType);
            svg.append("ellipse")
               .attr("cx", x)
               .attr("cy", y)
               .attr("rx", noteHeadRadius * 1.2)
               .attr("ry", noteHeadRadius)
               .attr("class", "note-head")
               .attr("fill", isFilled ? "#1f2937" : "none")
               .attr("stroke", "#1f2937")
               .attr("stroke-width", 1.5);

            if (durationType !== 'w') {
                 const staffCenterLineY = staffTop + lineSpacing * 2;
                 const stemHeight = 30;
                 const stemDirection = y > staffCenterLineY ? 1 : -1;
                 const stemX = stemDirection === 1 ? x - noteHeadRadius * 1.1 : x + noteHeadRadius * 1.1;
                 const stemY2 = y - stemHeight * stemDirection;
                 svg.append("line")
                    .attr("x1", stemX)
                    .attr("y1", y)
                    .attr("x2", stemX)
                    .attr("y2", stemY2)
                    .attr("class", "note-stem");
            }
        }

         function drawRhythmNote(svg, x, y, durationValue) {
             const noteHeadRadius = 5;
             let noteType = 'q';
             if (durationValue >= 1.9) noteType = 'w';
             else if (durationValue >= 0.9) noteType = 'h';
             else if (durationValue >= 0.4) noteType = 'q';
             else noteType = 'e';

             const isFilled = ['q', 'e', 's'].includes(noteType);
             svg.append("ellipse")
                .attr("cx", x)
                .attr("cy", y)
                .attr("rx", noteHeadRadius * 1.2)
                .attr("ry", noteHeadRadius)
                .attr("class", "note-head")
                .attr("fill", isFilled ? "#1f2937" : "none")
                .attr("stroke", "#1f2937")
                .attr("stroke-width", 1.5);

             if (noteType !== 'w') {
                  const stemHeight = 30;
                  const stemX = x + noteHeadRadius * 1.1;
                  svg.append("line")
                     .attr("x1", stemX)
                     .attr("y1", y)
                     .attr("x2", stemX)
                     .attr("y2", y - stemHeight)
                     .attr("class", "note-stem");
             }
         }

        function drawBarLine(svg, x, staffTop, staffHeight) {
             svg.append("line")
                .attr("x1", x).attr("y1", staffTop)
                .attr("x2", x).attr("y2", staffTop + staffHeight)
                .attr("class", "measure-line");
        }

        function midiToY(midiNote, staffTop, lineSpacing) {
            const G4_MIDI = 67;
            const G4_Y_POS = staffTop + lineSpacing;
            const semitonesFromG4 = midiNote - G4_MIDI;
            const diatonicSteps = [0, 0, 1, 1, 2, 3, 3, 4, 4, 5, 5, 6];
            let stepsFromG = 0;
            if (semitonesFromG4 >= 0) {
                const octave = Math.floor(semitonesFromG4 / 12);
                const noteInOctave = semitonesFromG4 % 12;
                stepsFromG = diatonicSteps[noteInOctave] + octave * 7;
            } else {
                 const octave = Math.floor(Math.abs(semitonesFromG4 + 11) / 12);
                 const noteInOctave = (semitonesFromG4 % 12 + 12) % 12;
                 stepsFromG = -(7 - diatonicSteps[noteInOctave] + octave * 7);
            }
            return G4_Y_POS - stepsFromG * (lineSpacing / 2);
        }

        const rhythmTempoSlider = document.getElementById('rhythm-tempo-slider');
        const rhythmTempoValue = document.getElementById('rhythm-tempo-value');
        const rhythmMeterSelect = document.getElementById('rhythm-meter-select');
        const rhythmComplexitySlider = document.getElementById('rhythm-complexity-slider');
        const rhythmComplexityValue = document.getElementById('rhythm-complexity-value');
        const generateRhythmBtn = document.getElementById('generate-rhythm-btn');
        const rhythmNotationSvgId = 'rhythm-notation-svg';
        let currentRhythmPattern = [];
        let currentTempo = 90;
        let staffTop = 0, lineSpacing = 10;

        function generateRhythm() {
            if (!rhythmMeterSelect || !rhythmComplexitySlider) return;
            const meter = rhythmMeterSelect.value;
            const complexity = parseInt(rhythmComplexitySlider.value);
            const [beats, beatType] = meter.split('/').map(Number);
            const numMeasures = 2;
            currentRhythmPattern = [];
            const beatUnitDuration = beatType === 8 ? 0.5 : 1;

            for (let m = 0; m < numMeasures; m++) {
                let currentMeasureBeats = 0;
                while (currentMeasureBeats < beats - 0.01) {
                     let durationBeats;
                     const rand = Math.random();
                     if (complexity === 1) durationBeats = 1;
                     else if (complexity === 2) durationBeats = (rand < 0.6) ? 1 : 0.5;
                     else if (complexity === 3) durationBeats = (rand < 0.4) ? 1 : (rand < 0.8 ? 0.5 : 0.25);
                     else if (complexity === 4) durationBeats = (rand < 0.3) ? 1 : (rand < 0.6 ? 0.5 : (rand < 0.9 ? 0.25 : 0.75));
                     else durationBeats = (rand < 0.2) ? 1 : (rand < 0.5 ? 0.5 : (rand < 0.8 ? 0.25 : (rand < 0.9 ? 0.75 : 1/3)));

                     if (currentMeasureBeats + durationBeats <= beats) {
                         currentRhythmPattern.push(durationBeats * beatUnitDuration);
                         currentMeasureBeats += durationBeats;
                     } else {
                         durationBeats = beats - currentMeasureBeats;
                          if(durationBeats > 0.1) currentRhythmPattern.push(durationBeats * beatUnitDuration);
                         currentMeasureBeats = beats;
                     }
                }
                 currentRhythmPattern.push('|');
            }
            drawRhythmNotation();
        }

        function drawRhythmNotation() {
            const setupResult = setupSVG(rhythmNotationSvgId, 100, 600);
            if (!setupResult) return;
            const { svg, width, height } = setupResult;
            const staffInfo = drawStaff(svg, width, height, 1);
            staffTop = staffInfo.staffTop;
            lineSpacing = staffInfo.lineSpacing;
            const staffHeight = staffInfo.staffHeight;
            const yPos = staffTop;
            let xPos = 30;
            const spaceFactor = 40;

            currentRhythmPattern.forEach(item => {
                if (item === '|') {
                    drawBarLine(svg, xPos, yPos - lineSpacing*1.5, lineSpacing * 3);
                    xPos += spaceFactor / 3;
                } else {
                    drawRhythmNote(svg, xPos, yPos, item);
                    xPos += item * spaceFactor * 2;
                }
                 if (xPos > width - 20) {
                     xPos = 30;
                 }
            });
             drawBarLine(svg, xPos, yPos - lineSpacing*1.5, lineSpacing * 3);
        }

        if(rhythmTempoSlider && rhythmTempoValue) rhythmTempoSlider.oninput = () => { rhythmTempoValue.textContent = rhythmTempoSlider.value; };
        if(rhythmComplexitySlider && rhythmComplexityValue) rhythmComplexitySlider.oninput = () => { rhythmComplexityValue.textContent = rhythmComplexitySlider.value; };
        if(generateRhythmBtn) generateRhythmBtn.onclick = generateRhythm;


        const intervalTypeSelect = document.getElementById('interval-type-select');
        const intervalComplexitySlider = document.getElementById('interval-complexity-slider');
        const intervalComplexityValue = document.getElementById('interval-complexity-value');
        const generateIntervalBtn = document.getElementById('generate-interval-btn');
        const showIntervalBtn = document.getElementById('show-interval-btn');
        const intervalNotationSvgId = 'interval-notation-svg';
        const intervalAnswerOutput = document.getElementById('interval-answer-output');
        let currentInterval = { midi1: 60, midi2: 64, name: "3¬™ Mayor" };

        const intervalMap = {
            "m2": 1, "M2": 2, "m3": 3, "M3": 4, "P4": 5, "A4": 6, "d5": 6, "P5": 7,
            "m6": 8, "M6": 9, "m7": 10, "M7": 11, "P8": 12, "m9": 13, "M9": 14, "m10": 15, "M10": 16
        };

        function generateInterval() {
            if (!intervalTypeSelect || !intervalComplexitySlider) return;
            const intervalType = intervalTypeSelect.value;
            const complexity = parseInt(intervalComplexitySlider.value);
            const baseMidi = 60 + Math.floor(Math.random() * 12);
            const intervalSemitones = intervalMap[intervalType];
            const midi2 = baseMidi + intervalSemitones;

            currentInterval = { midi1: baseMidi, midi2: midi2, name: intervalTypeSelect.options[intervalTypeSelect.selectedIndex].text };
            drawIntervalNotation();
            if(intervalAnswerOutput) {
                intervalAnswerOutput.classList.add('invisible');
                intervalAnswerOutput.textContent = "";
            }
        }

        function drawIntervalNotation() {
            const setupResult = setupSVG(intervalNotationSvgId, 100, 200);
             if (!setupResult) return;
            const { svg, width, height } = setupResult;
            const staffInfo = drawStaff(svg, width, height);
            staffTop = staffInfo.staffTop;
            lineSpacing = staffInfo.lineSpacing;
            drawClef(svg, staffTop, lineSpacing);

            const noteY1 = midiToY(currentInterval.midi1, staffTop, lineSpacing);
            const noteY2 = midiToY(currentInterval.midi2, staffTop, lineSpacing);

            drawNote(svg, 70, noteY1, 'h');
            drawNote(svg, 110, noteY2, 'h');
        }

        function showIntervalAnswer() {
             if(!intervalAnswerOutput) return;
             intervalAnswerOutput.textContent = `Intervalo: ${currentInterval.name}`;
             intervalAnswerOutput.classList.remove('invisible');
        }

        if(intervalComplexitySlider && intervalComplexityValue) intervalComplexitySlider.oninput = () => { intervalComplexityValue.textContent = intervalComplexitySlider.value; };
        if(generateIntervalBtn) generateIntervalBtn.onclick = generateInterval;
        if(showIntervalBtn) showIntervalBtn.onclick = showIntervalAnswer;


        const melodyDifficultySlider = document.getElementById('melody-difficulty-slider');
        const melodyDifficultyValue = document.getElementById('melody-difficulty-value');
        const melodyLengthSlider = document.getElementById('melody-length-slider');
        const melodyLengthValue = document.getElementById('melody-length-value');
        const melodyModeSelect = document.getElementById('melody-mode-select');
        const generateMelodyBtn = document.getElementById('generate-melody-btn');
        const melodyNotationSvgId = 'melody-notation-svg';
        let currentMelody = [];

        function generateMelody() {
             if(!melodyDifficultySlider || !melodyLengthSlider || !melodyModeSelect) return;
             const difficulty = parseInt(melodyDifficultySlider.value);
             const numBars = parseInt(melodyLengthSlider.value);
             const mode = melodyModeSelect.value;
             currentMelody = [];
             let currentMidi = 60 + Math.floor(Math.random() * 7);
             const beatsPerBar = 4;
             const notesPerBar = 4;

             const scaleIntervals = {
                 major: [2, 2, 1, 2, 2, 2, 1], minor: [2, 1, 2, 2, 1, 2, 2],
                 dorian: [2, 1, 2, 2, 2, 1, 2], mixolydian: [2, 2, 1, 2, 2, 1, 2],
                 chromatic: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
             };
             let scale = scaleIntervals[mode] || scaleIntervals.major;
             let currentScaleDegree = 0;

             for (let i = 0; i < numBars * notesPerBar; i++) {
                 currentMelody.push({ midi: currentMidi, duration: 1 });

                 let intervalSize = 0;
                 const r = Math.random();
                 const maxInterval = difficulty + 1;
                 intervalSize = Math.floor(Math.random() * (2 * maxInterval + 1)) - maxInterval;
                 intervalSize = Math.sign(intervalSize) * Math.max(1, Math.abs(intervalSize));

                 if (mode !== 'chromatic') {
                     let nextDegree = (currentScaleDegree + intervalSize + scale.length * 10) % scale.length;
                     let semitoneChange = 0;
                     if (intervalSize > 0) {
                         for(let k=0; k<intervalSize; k++) semitoneChange += scale[(currentScaleDegree + k) % scale.length];
                     } else if (intervalSize < 0) {
                         for(let k=0; k>intervalSize; k--) semitoneChange -= scale[(currentScaleDegree + k - 1 + scale.length*10) % scale.length];
                     }
                     currentMidi += semitoneChange;
                     currentScaleDegree = nextDegree;
                 } else {
                     currentMidi += intervalSize;
                 }
                 currentMidi = Math.max(55, Math.min(79, currentMidi));
             }
             drawMelodyNotation();
        }

        function drawMelodyNotation() {
            const setupResult = setupSVG(melodyNotationSvgId, 100, 600);
            if (!setupResult) return;
            const { svg, width, height } = setupResult;
            const staffInfo = drawStaff(svg, width, height);
            staffTop = staffInfo.staffTop;
            lineSpacing = staffInfo.lineSpacing;
            const staffHeight = staffInfo.staffHeight;
            let xPos = drawClef(svg, staffTop, lineSpacing);
            xPos = drawTimeSignature(svg, xPos, staffTop, lineSpacing, 4, 4);
            const noteSpacing = 35;
            const beatsPerBar = 4;
            let currentBeat = 0;

            currentMelody.forEach((note, index) => {
                if (currentBeat >= beatsPerBar) {
                    drawBarLine(svg, xPos - noteSpacing / 2, staffTop, staffHeight);
                    currentBeat = 0;
                }
                if (xPos > width - 30) return;
                const yPos = midiToY(note.midi, staffTop, lineSpacing);
                drawNote(svg, xPos, yPos, 'q');
                xPos += noteSpacing;
                currentBeat += note.duration;
            });
             drawBarLine(svg, xPos - noteSpacing / 2, staffTop, staffHeight);
        }

        if(melodyDifficultySlider && melodyDifficultyValue) melodyDifficultySlider.oninput = () => { melodyDifficultyValue.textContent = melodyDifficultySlider.value; };
        if(melodyLengthSlider && melodyLengthValue) melodyLengthSlider.oninput = () => { melodyLengthValue.textContent = melodyLengthSlider.value; };
        if(generateMelodyBtn) generateMelodyBtn.onclick = generateMelody;

        window.addEventListener('load', () => {
             generateRhythm();
             generateInterval();
             generateMelody();
        });

    </script>

</body>
</html>

